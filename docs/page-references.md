# Page References Feature

## ЁЯУД **р╕ар╕▓р╕Юр╕гр╕зр╕б**

р╕гр╕░р╕Ър╕Ъ RAG Chatbot р╣Др╕Фр╣Йр╣Ар╕Юр╕┤р╣Ир╕бр╕Яр╕╡р╣Ар╕Ир╕нр╕гр╣М **р╕Бр╕▓р╕гр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕лр╕Щр╣Йр╕▓** р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Чр╕гр╕▓р╕Ър╕зр╣Ир╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕бр╕▓р╕Ир╕▓р╕Бр╕лр╕Щр╣Йр╕▓р╣Др╕лр╕Щр╕Вр╕нр╕Зр╣Ар╕нр╕Бр╕кр╕▓р╕г

### ЁЯОп **р╕Ыр╕гр╕░р╣Вр╕вр╕Кр╕Щр╣М:**

- ЁЯУН **р╕гр╕░р╕Ър╕╕р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З**: р╕гр╕╣р╣Йр╕зр╣Ир╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕бр╕▓р╕Ир╕▓р╕Бр╕лр╕Щр╣Йр╕▓р╣Др╕лр╕Щ
- ЁЯФН **р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Др╕Фр╣Й**: р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Ыр╕┤р╕Фр╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Др╕Ыр╕Фр╕╣р╕лр╕Щр╣Йр╕▓р╣Др╕Фр╣Й
- ЁЯУЪ **р╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╣Др╕Фр╣Й**: р╣Гр╕Кр╣Йр╣Гр╕Щр╕Бр╕▓р╕гр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Чр╕▓р╕Зр╕зр╕┤р╕Кр╕▓р╕Бр╕▓р╕г
- ЁЯОУ **р╕Щр╣Ир╕▓р╣Ар╕Кр╕╖р╣Ир╕нр╕Цр╕╖р╕н**: р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕зр╕▓р╕бр╕Щр╣Ир╕▓р╣Ар╕Кр╕╖р╣Ир╕нр╕Цр╕╖р╕нр╕Вр╕нр╕Зр╕Др╕│р╕Хр╕нр╕Ъ

## ЁЯФз **р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ**

### 1. **р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓**

```typescript
// lib/page-calculator.ts
export function calculatePageNumber(
  chunkIndex: number,
  totalChunks: number,
  chunkContent: string,
  documentName: string
): PageInfo
```

**р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У:**
- **Position-based**: р╣Гр╕Кр╣Йр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕Вр╕нр╕З chunk р╣Гр╕Щр╣Ар╕нр╕Бр╕кр╕▓р╕г
- **Content-based**: р╣Гр╕Кр╣Йр╕Др╕зр╕▓р╕бр╕вр╕▓р╕зр╕Вр╕нр╕Зр╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓
- **Document-specific**: р╕Ыр╕гр╕▒р╕Ър╕Хр╕▓р╕бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Ар╕нр╕Бр╕кр╕▓р╕г

### 2. **р╕гр╕░р╕Фр╕▒р╕Ър╕Др╕зр╕▓р╕бр╣Бр╕бр╣Ир╕Щр╕вр╕│ (Confidence)**

```typescript
export interface PageInfo {
  pageNumber: number
  confidence: 'high' | 'medium' | 'low'
  reason: string
}
```

- **High**: р╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Ар╕ер╣Зр╕Б р╕лр╕гр╕╖р╕нр╕Юр╕Ър╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓р╣Гр╕Щр╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓
- **Medium**: р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Вр╕Щр╕▓р╕Фр╕Бр╕ер╕▓р╕З
- **Low**: р╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Гр╕лр╕Нр╣И р╕лр╕гр╕╖р╕нр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╣Ар╕Юр╕╡р╕вр╕Зр╕Юр╕н

### 3. **р╕Бр╕▓р╕гр╣Бр╕кр╕Фр╕Зр╕Ьр╕е**

```typescript
// р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
"р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1 - р╕лр╕Щр╣Йр╕▓ 3"
"р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1 - р╕лр╕Щр╣Йр╕▓ 7 (р╕Ыр╕гр╕░р╕бр╕▓р╕У)"
```

## ЁЯУЛ **р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ**

### 1. **р╣Гр╕Щ Chat API**

```typescript
// app/api/chat/route.ts
const context = relevantContent.map((doc) => {
  const pageRef = formatPageReference(doc.source, doc.pageNumber, doc.pageConfidence)
  return `[${pageRef}]\n${doc.content}`
}).join("\n\n")
```

### 2. **р╣Гр╕Щ System Prompt**

```typescript
const systemPrompt = `р╕Др╕╕р╕Ур╕Др╕╖р╕н AI р╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕вр╕зр╕┤р╕Кр╕▓р╕Бр╕▓р╕гр╕Чр╕╡р╣Ир╕Хр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╣Вр╕Фр╕вр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Ир╕▓р╕Бр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Щр╕Бр╕▓р╕гр╕кр╕нр╕Щр╕Чр╕╡р╣Ир╣Гр╕лр╣Йр╕бр╕▓р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ

р╕Бр╕Ор╕Бр╕▓р╕гр╕Хр╕нр╕Ъ:
5. р╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╣Бр╕лр╕ер╣Ир╕Зр╕Чр╕╡р╣Ир╕бр╕▓р╕Вр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕гр╣Йр╕нр╕бр╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓ (р╣Ар╕Кр╣Ир╕Щ [р╕Кр╕╖р╣Ир╕нр╕зр╕┤р╕Кр╕▓ - р╕Кр╕╖р╣Ир╕нр╕лр╕▒р╕зр╕Вр╣Йр╕н - р╕лр╕Щр╣Йр╕▓ X]) р╣Ар╕бр╕╖р╣Ир╕нр╣Ар╕лр╕бр╕▓р╕░р╕кр╕б
7. р╕гр╕░р╕Ър╕╕р╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓р╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Чр╕╡р╣Ир╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
`
```

### 3. **р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М**

**р╕Др╕│р╕Цр╕▓р╕б:** "р╕нр╕▓р╕Ир╕▓р╕гр╕вр╣Мр╕Кр╕╖р╣Ир╕нр╕нр╕░р╣Др╕г"

**р╕Др╕│р╕Хр╕нр╕Ъ:** "р╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╣Ар╕нр╕Бр╕кр╕▓р╕г [р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1 - р╕лр╕Щр╣Йр╕▓ 3] р╕нр╕▓р╕Ир╕▓р╕гр╕вр╣Мр╕Кр╕╖р╣Ир╕н..."

## ЁЯУК **р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ**

### 1. **Single Page Reference**
```typescript
import { formatPageReference } from "@/lib/page-calculator"

const reference = formatPageReference("р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1", 3, "high")
// р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М: "р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1 - р╕лр╕Щр╣Йр╕▓ 3"
```

### 2. **Multiple Page References**
```typescript
import { formatMultiplePageReferences } from "@/lib/page-calculator"

const references = [
  { source: "р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1", pageNumber: 3 },
  { source: "р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1", pageNumber: 5 },
  { source: "р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1", pageNumber: 7 },
]

const formatted = formatMultiplePageReferences(references)
// р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М: "р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ - р╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓ р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Чр╕╡р╣И 1 - р╕лр╕Щр╣Йр╕▓ 3, 5, 7"
```

### 3. **Demo Function**
```typescript
import { demoPageReferences } from "@/examples/page-reference-demo"

// р╕гр╕▒р╕Щ demo р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╣р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ
await demoPageReferences()
```

## ЁЯФН **р╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╣Бр╕Хр╣Ир╕З**

### 1. **р╕Ыр╕гр╕▒р╕Ър╕Ир╕│р╕Щр╕зр╕Щр╕лр╕Щр╣Йр╕▓р╕Хр╣Ир╕нр╣Ар╕нр╕Бр╕кр╕▓р╕г**

```typescript
// lib/page-calculator.ts
// р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Др╣Ир╕▓р╣Ар╕лр╕ер╣Ир╕▓р╕Щр╕╡р╣Йр╕Хр╕▓р╕бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Ар╕нр╕Бр╕кр╕▓р╕г
const pagesPerDocument = {
  biology: 12,    // р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Кр╕╡р╕зр╕зр╕┤р╕Чр╕вр╕▓
  math: 18,       // р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Др╕Ур╕┤р╕Хр╕ир╕▓р╕кр╕Хр╕гр╣М
  default: 15     // р╕Др╣Ир╕▓р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ
}
```

### 2. **р╕Ыр╕гр╕▒р╕Ър╕Др╕зр╕▓р╕бр╣Бр╕бр╣Ир╕Щр╕вр╕│**

```typescript
// р╕Ыр╕гр╕▒р╕Ъ threshold р╕кр╕│р╕лр╕гр╕▒р╕Ъ confidence levels
if (totalChunks <= 5) {
  confidence = 'high'
} else if (totalChunks > 20) {
  confidence = 'low'
}
```

## ЁЯУИ **р╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Ю**

### тЬЕ **р╕Вр╣Йр╕нр╕Фр╕╡:**
- ЁЯУН **р╣Бр╕бр╣Ир╕Щр╕вр╕│**: р╕Др╕│р╕Щр╕зр╕Ур╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓р╕нр╕вр╣Ир╕▓р╕Зр╣Бр╕бр╣Ир╕Щр╕вр╕│
- ЁЯФН **р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Др╕Фр╣Й**: р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Ыр╕┤р╕Фр╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Др╕Ыр╕Фр╕╣р╣Др╕Фр╣Й
- ЁЯУЪ **р╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╣Др╕Фр╣Й**: р╣Гр╕Кр╣Йр╣Гр╕Щр╕Бр╕▓р╕гр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Чр╕▓р╕Зр╕зр╕┤р╕Кр╕▓р╕Бр╕▓р╕г
- ЁЯОУ **р╕Щр╣Ир╕▓р╣Ар╕Кр╕╖р╣Ир╕нр╕Цр╕╖р╕н**: р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕зр╕▓р╕бр╕Щр╣Ир╕▓р╣Ар╕Кр╕╖р╣Ир╕нр╕Цр╕╖р╕н

### тЪая╕П **р╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Ф:**
- ЁЯУД **р╕Ыр╕гр╕░р╕бр╕▓р╕Ур╕Бр╕▓р╕г**: р╣Ар╕Ыр╣Зр╕Щр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕▓р╕Ур╕Бр╕▓р╕г р╣Др╕бр╣Ир╣Гр╕Кр╣Ир╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╣Бр╕Чр╣Йр╕Ир╕гр╕┤р╕З
- ЁЯУК **р╕Вр╕╢р╣Йр╕Щр╕Бр╕▒р╕Ър╕Вр╕Щр╕▓р╕Фр╣Ар╕нр╕Бр╕кр╕▓р╕г**: р╕Др╕зр╕▓р╕бр╣Бр╕бр╣Ир╕Щр╕вр╕│р╕Вр╕╢р╣Йр╕Щр╕Бр╕▒р╕Ър╕Ир╕│р╕Щр╕зр╕Щ chunks
- ЁЯФН **р╣Др╕бр╣Ир╕Юр╕Ър╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓**: р╕лр╕▓р╕Бр╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Др╕бр╣Ир╕бр╕╡р╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓

## ЁЯЪА **р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ**

### 1. **р╕Чр╕Фр╕кр╕нр╕Ър╣Гр╕Щр╣Ар╕зр╣Зр╕Ъ**
```bash
npm run dev
# р╣Ар╕Ыр╕┤р╕Ф http://localhost:3000
# р╕Цр╕▓р╕бр╕Др╕│р╕Цр╕▓р╕бр╣Бр╕ер╕░р╕Фр╕╣р╕Бр╕▓р╕гр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕лр╕Щр╣Йр╕▓
```

### 2. **р╕Чр╕Фр╕кр╕нр╕Ъ Demo**
```typescript
import { demoPageReferences, demoConfidenceLevels, demoMultiplePages } from "@/examples/page-reference-demo"

// р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ
await demoPageReferences()
demoConfidenceLevels()
demoMultiplePages()
```

## ЁЯУБ **р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З**

```
lib/
тФЬтФАтФА page-calculator.ts      # р╕гр╕░р╕Ър╕Ър╕Др╕│р╕Щр╕зр╕Ур╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓
тФЬтФАтФА rag.ts                 # р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Юр╕┤р╣Ир╕б page info
тФФтФАтФА document-cache.ts      # р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е chunks

app/api/chat/
тФФтФАтФА route.ts               # р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕кр╕Фр╕З page references

examples/
тФФтФАтФА page-reference-demo.ts # Demo р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ

docs/
тФФтФАтФА page-references.md     # р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Щр╕╡р╣Й
```

## ЁЯОп **р╕кр╕гр╕╕р╕Ы**

р╕гр╕░р╕Ър╕Ър╣Др╕Фр╣Йр╣Ар╕Юр╕┤р╣Ир╕бр╕Яр╕╡р╣Ар╕Ир╕нр╕гр╣М **р╕Бр╕▓р╕гр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕лр╕Щр╣Йр╕▓** р╕кр╕│р╣Ар╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з:

- тЬЕ **р╕Др╕│р╕Щр╕зр╕Ур╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓**: р╣Гр╕Кр╣Йр╕лр╕ер╕▓р╕вр╕зр╕┤р╕Шр╕╡р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╣Бр╕бр╣Ир╕Щр╕вр╕│
- тЬЕ **р╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╣Гр╕Щр╕Др╕│р╕Хр╕нр╕Ъ**: AI р╕Ир╕░р╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕лр╕Щр╣Йр╕▓р╕Фр╣Йр╕зр╕в
- тЬЕ **р╕гр╕░р╕Фр╕▒р╕Ър╕Др╕зр╕▓р╕бр╣Бр╕бр╣Ир╕Щр╕вр╕│**: р╣Бр╕кр╕Фр╕Зр╕Др╕зр╕▓р╕бр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕▒р╣Ир╕Щр╕Вр╕нр╕Зр╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕лр╕Щр╣Йр╕▓
- тЬЕ **р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Зр╣Ир╕▓р╕в**: р╕Чр╕│р╕Зр╕▓р╕Щр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤

**ЁЯОЙ р╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Бр╕ер╣Йр╕з!** 